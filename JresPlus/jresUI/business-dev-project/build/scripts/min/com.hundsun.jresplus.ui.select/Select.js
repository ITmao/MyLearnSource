Horn.Select=Horn.extend(Horn.Field,{COMPONENT_CLASS:"Select",delimiter:",",bodyclicktype:"click.select",select:null,field:null,hidden:null,listEl:null,multipleline:false,name:null,alias:null,showLabel:true,hasHeadItem:false,tempCheckedKeyArray:[],tempCheckedValue:"",init:function(c){Horn.Select.superclass.init.apply(this,arguments);var h=this;this.select=this.el;this.hidden=this.select.children("input[type='hidden']");this.field=this.hidden.next();this.name=this.hidden.attr("name");this.alias=this.hidden.attr("alias")||"";this.img=this.select.find(".u-select-down");if(this.field.attr("delimiter")!=undefined){this.delimiter=this.field.attr("delimiter")}var g=this.params.headItem;if(g){this.hasHeadItem=true}var f=this.field.attr("ref");this.listEl=f?Horn.getCurrent().find("div.hc_hide_div").children("div.hc_checkboxdiv[ref_target='"+f+"']"):this.field.next().next("div.hc_checkboxdiv");if(!this.listEl.get(0)){this.listEl=$("div.hc_hide_div").children("div.hc_checkboxdiv[ref_target='"+f+"']")}this.listEl=this.listEl.first();this.multipleline=this.params.multiple;if(String(this.params.showLabel)=="false"){this.showLabel=false}this.createHeadItem();this.setEditable(this.params.editable);this.setReadonly(this.params.readonly);this.field.bind({focus:Horn.Util.apply(h.onFocus,h),click:Horn.Util.apply(h.onClick,h),keydown:Horn.Util.apply(h.onKeyDown,h),keypress:Horn.Util.apply(h.onKeyPress,h),keyup:Horn.Util.apply(h.onKeyUp,h)});if(!this.params.disabled){this.img.bind({click:Horn.Util.apply(h.onFocus,h)})}var l=this.params.value||this.hidden.val();if(l===""){this.setValue("",undefined,true)}else{var e=this.el.attr("keyfield");var b=this.el.attr("titlefield");var j=this.params.items;if(j&&j.length>0){for(var d=0;d<j.length;d++){var m=j[d];var k=m.code;if(!k){k=m.label}var a=m.text;if(!a){a=m.value}if(e){k=m[""+e+""]}if(b){a=m[""+b+""]}if(m!=null&&k==l){this.field.val(a);this.hidden.val(l)}}}}if(this.params.disabled){this.setDisabled(true)}this.DICT=(function(n){if(n.params.items){var i={};$(n.params.items).each(function(o,p){i[p.label]=p.value});return i}else{return Horn.getDict(n.params.dictName)}})(this);if(this.params.filterBy){this.params.enableFieldSearch=true}else{this.params.filterBy="keyOrValue"}if(this.params.enableFieldSearch){this.enableFieldSearch=true;this.enableFieldQuery(true)}if(this.params.editable){this.field.bind("blur",function(){if(!h.editflag){return}h.editflag=false;var i=h.tempCheckedValue.replace(",",h.delimiter);$(this).attr("value",i)})}},enableFieldQuery:function(b){var g=this;var a;var f=this.getIEVersion();var e=(f=="8"||f=="7");if(e){a="propertychange"}else{a="input"}if(!b){g.enableFieldSearch=false;g.searchField.unbind(a);g.searchField.remove();return}else{this.enableFieldSearch=true}var d=$("<input type='text' value='' name='fieldToSearch' class='u-select' style='display:none'/>");d.appendTo(this.el);this.searchField=d;this.searchField.blur(function(){g.searchField.hide();g.field.show()});this.searchField.click(function(){return false});var c=function(){var h=g.searchField.val();if(h!=""){$("li",g.listEl).each(function(l,n){var m=false;var k=false;var j=false;if(g.params.filterBy=="key"){m=!($(n).attr("key").indexOf(h)!=-1)}else{if(g.params.filterBy=="value"){m=!($(n).attr("title").indexOf(h)!=-1)}else{if(g.params.filterBy=="keyOrValue"){k=!($(n).attr("key").indexOf(h)!=-1);j=!($(n).attr("title").indexOf(h)!=-1);if(k==false||j==false){m=false}else{m=true}}}}if(m){$(n).hide()}else{$(n).show()}})}else{$("li",g.listEl).each(function(j,k){$(k).show()})}};g.searchField.bind(a,c);g.searchField.bind("focus",c);g.searchField.bind("keyup",function(){var h=g.searchField.val();if(h==""){g.field.focus()}});g.searchField.bind({keydown:Horn.Util.apply(g.onKeyDown,g)})},getIEVersion:function(){var c=-1;if(navigator.appName=="Microsoft Internet Explorer"){var a=navigator.userAgent;var b=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(b.exec(a)!=null){c=parseFloat(RegExp.$1)}}else{if(navigator.appName=="Netscape"){var a=navigator.userAgent;var b=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})");if(b.exec(a)!=null){c=parseFloat(RegExp.$1)}}}return c},setDisabled:function(a){if(a===false){this.setEnable(true);this.disabled=false}else{this.setEnable(false);this.disabled=true}},setReadonly:function(a){if(!a){a=false}if(a===false){this.el.removeAttr("readonly");this.readonly=false}else{this.el.attr("readonly",true);this.readonly=true;this.setEditable(false)}},setEditable:function(a){if(!a){a=false}if(a===true){this.field.removeAttr("readonly");this.editable=true}else{this.field.attr("readonly",true);this.editable=false}},createHeadItem:function(){var d=this.params.headItem;var a=this.params.multiple;if(this.hasHeadItem){var b=d.label?d.label:"";var f=d.pLabel?d.pLabel:"";var e=d.value?d.value:"";var c="<li key='"+b+"' pkey='"+f+"' title='"+e+"' headItem='"+this.name+"' ><label>"+e+"</label></li>";this.listEl.children("ul").prepend(c);this.field.val(e)}if(this.params.emptyText&&this.params.emptyText!=""){this.field.val(e)}},handerHeadItem:function(){var e=this.name;var a=this.listEl.children("ul");if(a.length>0){if(this.hasHeadItem){var d=false;var c=a.children("li[headItem]");if(c.length>0){c.each(function(f,h){var g=$(h).attr("headItem");if(e!=g){$(h).remove()}else{d=true}});if(d){return}else{this.createHeadItem()}}else{this.createHeadItem()}}else{var b=a.children("li[headItem]");if(b.length>0){b.remove()}}}},setValue:function(l,c,k){if(this.listEl&&this.listEl.length==0){this.listEl=this.field.parent().find("div.hc_checkboxdiv")}this.handerHeadItem();var q=this.hidden;var b=q.val();var a=this.field;if(l===undefined||l===null){a.val("");q.val("");return false}if(l==""){q.val("");this.tempCheckedKeyArray=[]}if($.type(l)=="string"||$.type(l)=="number"){l={key:l+""}}var g=this.listEl.children("ul");if(this.listEl.length>0){if(this.multipleline){if(l.key==null||l.key==""){a.val("")}else{if(l.text){a.val(l.text)}else{var s=[];var d=[];if(this.delimiter!=""){d=l.key.split(this.delimiter)}else{d=l.key.toCharArray()}this.tempCheckedKeyArray=d;if(this.params.dictName){for(var r=0;r<d.length;r++){s.push(Horn.getDict(this.params.dictName)[d[r]])}}else{var h=this.getListData().data;for(var r=0;r<d.length;r++){for(var o=0;o<h.length;o++){if(d[r]==h[o].key){s.push(h[o].value)}}}}s=s.toString().replace(/,/g,this.delimiter);a.val(s);a.attr("title",s)}}q.val(l.key)}else{if(!l.text){var f=g.children("li[key='"+l.key+"']");l.text=jQuery.trim(f.text());if(!this.showLabel){var p=f.find("span");l.text=l.text.replace(p.text(),"")}}if(l.text!=""){var m=l.text;if($.type(l)=="string"){m=m+"";m=m.replace(/(^\s+)|(\s+$)/g,"");m=m.replace(/\s/g,"")}a.val(m);q.val(l.key)}else{if(l.key==""){a.val("")}else{return}}}if(c&&b!=l.key){a.trigger("change",[l.key])}}if(this.multipleline){var t=this.hidden.val();var e=[];var n=this;if(t!=""&&t!=null){$("input[type='checkbox']",this.listEl).each(function(v,A){var u=$(A).parent().parent("li[key]");var y=u.attr("key");var z=t.split(n.delimiter);var j=z.length;for(var x=0;x<j;x++){var w=z[x];if(y==w){e.push(w)}}});this.hidden.val(e.join(this.delimiter))}}this.tempCheckedValue=this.field.val();if(!k){this.validate()}},getValue:function(f){this.handerHeadItem();if(f){var e=this;var d=this.hidden.val();var i=function(j){return e.DICT[j]||null};if(this.multipleline){var a=d.split(this.delimiter);var g=[];$(a).each(function(j,k){var l=i(k);if(l){g.push(l)}});return g.join(this.delimiter)}else{return i(d)}}var b=this.hidden.val();var c=this.listEl.find("ul>li");var h="";if(!this.params.multiple||this.params.multiple==false){if(this.params.value){$.each(c,function(j,k){if($(k).attr("key")==b){h="has"}});if(!h){b=""}}}return b},onClick:function(a){if(this.searchField){this.field.hide();this.searchField.show();this.searchField.focus()}},onFocus:function(h){if(this.disabled){return}var d=$(h.currentTarget);if(d.hasClass("u-select-down")){d=$(h.currentTarget).prev()}var c=this.listEl;var g=d.data("isFromOuter");if(c.length>0){var f="";if(this.searchField){f=this.searchField.val()}if(f!=""){}else{this.showList(d,c)}}else{var i=this.field.attr("ref");this.listEl=i?this.el.parents(".h_floatdiv").find("div.hc_hide_div").children("div.hc_checkboxdiv[ref_target='"+i+"']"):this.field.next("div.hc_checkboxdiv");if(this.listEl.length>0){this.showList(d,this.listEl)}this.multipleline=this.listEl.attr("multiple_line")=="true"}if(this.enableFieldSearch){var b=this.el.find("input[name=fieldToSearch]");if(b.size()==2){b.first().remove()}var a=this.field.val();if(a==""){this.field.hide();this.searchField.show();this.searchField.focus()}}},onKeyDown:function(g){var k=g.keyCode;var f=this.listEl;var h=f.children("ul");var l=h.children("li");var j=h.children("li.h_cur");var a=f.get(0);var i=h.children("li").last().get(0);if(g.ctrlKey&&k===65&&this.multipleline){var d=h.find("input:not(:checked)");if(d.length==0){l.removeClass("h_cur");d=l.children("label").children("input");d.each(function(m,e){e.checked=false});this.setValue("")}else{d.each(function(m,e){var n=$(e).parent("label").parent("li").is(":visible");if(n){e.checked=true;$(e).parent("label").parent("li").addClass("h_cur")}});if(this.searchField){this.searchField.val("");this.searchField.hide();this.field.show()}d.last().parent("label").parent("li").triggerHandler("click.li")}Horn.Util.stopPropagation(g);return false}else{if(k===38){if(!this.multipleline){var b=j.prev();if(b.length){a.scrollTop=b.get(0).offsetTop+(a.scrollHeight-a.clientHeight)-i.offsetTop;j.removeClass("h_cur");b.addClass("h_cur")}}}else{if(k===40){if(!this.multipleline){var c=j.next();if(c.length){a.scrollTop=c.get(0).offsetTop+(a.scrollHeight-a.clientHeight)-i.offsetTop;j.removeClass("h_cur");c.addClass("h_cur")}}}else{if(k===46||k===8){}else{if(k===9){this.hideList(this.field,f)}else{if(k===13||k===32){if(!this.multipleline){j.trigger("click.li");Horn.Util.stopPropagation(g)}return false}else{}}}}}}},onKeyPress:function(f){var m=f.keyCode;var l=String.fromCharCode(m);var c="";var d=this.listEl;var g=d.children("ul");var k=g.children("li");if(m>=65&&m<=90){c=l.toLowerCase()}else{c=l.toUpperCase()}var b=this.selectLi(l,c);var j=k.last().get(0);var a=d.get(0);if(m===38){}else{if(m===46||m===8){}else{if(m===40){}else{if(m===13){}else{if(this.multipleline){var i=this.getValue();if(i.indexOf(l)==-1){if(b){var h=b.children("label").children("input");if(!h.get(0).checked){h.get(0).checked=true}}}else{}}if(b){a.scrollTop=b.get(0).offsetTop+(a.scrollHeight-a.clientHeight)-j.offsetTop}}}}}Horn.Util.stopPropagation(f)},onKeyUp:function(f){var d=this.listEl;var h=this;if(this.multipleline&&!this.params.enableFieldSearch){if(h.params.editable){h.editflag=true}var g=this.field.val();var b=[];var c=[];var a="";$("input[type='checkbox']",d).each(function(l,j){var p=$(j).parent().parent("li[key]");var n=p.attr("title");var e=p.attr("key");$(j).prop("checked",false);var q=g.split(/[\,,\，]/);var m=q.length;for(var k=0;k<m;k++){var o=q[k];if(n==o||o==e){b.push(e);c.push(n);a=a+q[k]+",";$(j).prop("checked",true)}}if($(j).prop("checked")){p.addClass("h_cur")}else{p.removeClass("h_cur")}p.focus()});a=a.substring(0,a.length-1);this.tempCheckedKeyArray=b;this.tempCheckedValue=c.toString();h.hidden.val(b)}Horn.Util.stopPropagation(f)},bodyClick:function(f){var d=this.getEventTarget();if(f.target==f.data.inputEl.get(0)||d.data("isFromOuter")||$(f.target).prev()[0]==f.data.inputEl.get(0)){d.data("isFromOuter",false);var c=f.data.listEl;var b=f.data.inputEl;this.showList(b,c);$(document).one(this.bodyclicktype,f.data,Horn.Util.apply(this.bodyClick,this))}else{var c=f.data.listEl;var b=f.data.inputEl;c.hide();if(!c.data("show_name")){return}var a=$("li[key]",c);a.unbind("click.li");c.data("show_name","");if(this.searchField){this.searchField.val("")}}},listClick:function(f){var h=this;var b=$(f.currentTarget);var d=f.data.listEl;var c={};if(h.multipleline){var g=new Array();var a=new Array();$("input[type='checkbox']:checked",d).each(function(i,k){var j=$(k).parent().parent("li[key]").attr("key");var e=$(k).parent().parent("li[key]").attr("title");if(j){g.push(j);a.push(e)}});this.tempCheckedKeyArray=g;this.field.attr("TITLE",a.toString());c.key=g.join(h.delimiter);c.text=a.join(h.delimiter);if($("input[type='checkbox']",b).get(0).checked){b.addClass("h_cur")}else{b.removeClass("h_cur")}f.stopPropagation();this.setValue(c,true,true)}else{b.addClass("h_cur");b.siblings().removeClass("h_cur");this.setValue(b.attr("key"),true,true)}this.field.trigger("blur");this.tempCheckedValue=this.field.val();if(h.multipleline){this.field.focus()}},hideList:function(c,b){if(!b.data("show_name")){return}b.hide();var a=$("li[key]",b);a.unbind("click.li");b.data("show_name","")},longerList:false,changeToLongerList:function(){this.longerList=true},showList:function(m,g){this.handerHeadItem();var i=this;if(this.readonly==true){return false}if(this.enableFieldSearch){var j=this.searchField.val();if(j!=""){$("li",g).each(function(n,p){$(p).show()})}}var h=m.prev();if(g.data("show_name")==h.attr("name")){return}this.hideAllList(g);var f={inputEl:m,listEl:g};if(g.offsetParent()!=m.offsetParent()){g.appendTo(m.offsetParent())}var k=m.position(),e=m.outerHeight();g.css("left",k.left+"px");g.css("top",(k.top+e)+"px");var d=this.getIEVersion();if(d=="9"){var l=g.children("ul").children("li");if(l.length>3){g.css("width",(m.outerWidth()*(this.longerList?2:1)-2)+18+"px")}else{g.css("width",(m.outerWidth()*(this.longerList?2:1)-2)+"px")}}else{g.css("width",(m.outerWidth()*(this.longerList?2:1)-2)+"px")}g.css("display","block");g.data("show_name",h.attr("name"));$(document).one(i.bodyclicktype,f,Horn.Util.apply(i.bodyClick,i));var c=$("li[key]",g);c.bind("click.li",f,Horn.Util.apply(i.listClick,i));c.removeClass("h_cur");var b=this.tempCheckedKeyArray.toString();if(b==""){b=this.hidden.val()}if(this.multipleline){$("input[type='checkbox']",g).each(function(o,t){var n=$(t).parent().parent("li[key]");var r=n.attr("key");$(t).prop("checked",false);var s=b.split(i.delimiter);for(var q=0;q<s.length;q++){var p=s[q];if(r==p){$(t).prop("checked",true)}}if($(t).prop("checked")){n.addClass("h_cur")}else{n.removeClass("h_cur")}n.focus()})}else{var a=this.hidden.val();var l=g.children("ul").children("li[key='"+a+"']");l.addClass("h_cur");l.focus()}if(this.showLabel){this.listEl.find("span.hce_dictlabel").show()}else{this.listEl.find("span.hce_dictlabel").hide()}},hideAllList:function(a){$("div.hc_checkboxdiv").each(function(b,c){if(a.get(0)!=c){$(c).hide();$(c).data("show_name","")}})},selectLi:function(g,c){var b=this.listEl.children("ul").children("li");var f=null;for(var e=0;e<b.size();e++){var a=$(b.get(e));var d=a.attr("key");if(d&&d.indexOf(g)==0){f=a;break}}if(f==null&&!this.multipleline){for(var e=0;e<b.size();e++){var a=$(b.get(e));var d=a.attr("key");if(d&&d.indexOf(c)==0){f=a;break}}}if(f!=null){if(!this.multipleline){f.siblings().removeClass("h_cur");f.addClass("h_cur")}}return f},bind:function(b,a){this.field.bind(b,[this.hidden],a)},setEnable:function(a){if(a){this.field.removeAttr("disabled");this.hidden.removeAttr("disabled")}else{this.hidden.attr("disabled","disabled");this.field.attr("disabled","disabled")}},getListData:function(){var a={};var b=[];if(this.listEl&&this.listEl.length==0){this.listEl=this.field.parent().find("div.hc_checkboxdiv")}if(this.multipleline){$("input[type='checkbox']",this.listEl).each(function(d,f){var c=$(f).parent().parent("li[key]");var e={};e.key=c.attr("key");e.value=c.attr("title");b.push(e)})}else{$("li[key!='']",this.listEl).each(function(d,f){var c=$(f);var e={};e.key=c.attr("key");e.value=c.attr("title");b.push(e)})}a.data=b;a.dom=this.listEl;return a}});Horn.Field.regFieldType("div.hc_select",Horn.Select);