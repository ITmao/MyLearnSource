Horn.SelectTree=Horn.extend(Horn.Field,{COMPONENT_CLASS:"SelectTree",hidden:null,field:null,ref:null,listEl:null,treeEl:null,_this:null,expandFirst:true,callback:null,init:function(){Horn.SelectTree.superclass.init.apply(this,arguments);var a=this.name;this.field=this.el.children("input[type='text'][ref*='"+a+"']");this.hidden=this.field.prev();this.name=this.hidden.attr("name");this.ref=this.field.attr("ref");this.img=this.el.find(".u-select-down");c=this;expandFirst=false;if(this.hidden.attr("expandFirst")){expandFirst=this.params.expandFirst}this.field.bind({focus:Horn.Util.apply(this.onFocus,this)});if(this.params.afterClear){var b=this.params.afterClear.replace("(","").replace(")","");this.callback=window[b]}var c=this;this.el.children("a").bind({click:Horn.Util.apply(c.delVal,c)});this.initZTree()},delVal:function(){if(this.params.disabled){return}var b=this;var a=this.field.val();if(a!=""){if(this.params.confirm){Horn.Msg.confirm("确认","你确定要清除该值？",function(){b.hidden.val("");b.field.val("");b.field.attr("selectnodes","");b.field.attr("pIds","");if(b.callback){b.callback()}},function(){})}else{b.hidden.val("");b.field.val("");b.field.attr("selectnodes","");b.field.attr("pIds","");if(b.callback){b.callback()}}}},initZTree:function(){var i=Horn.getCurrent();this.listEl=i.find("div.hc_selectbox-tree-div[ref_target='"+this.ref+"']");if(this.listEl.length==0){var a=this.hidden.attr("name").replace(/\./,"_");var h=[];h.push("<div class='hc_selectbox-tree-div' ref_target='ztree_"+a+"'>");h.push("<div class='hc_selectbox-tree-left'>");h.push("<ul class='ztree' id='ztree_"+a+"'>");h.push("</ul>");h.push("</div>");h.push("</div>");var l=i.find("div.hc_hide_div-tree");if(l.length==0){l=$('<div class="hc_hide_div-tree"></div>').appendTo(i)}var n=this.el.parents("div.h_floatdiv-con");if(n.length==0){this.listEl=$(h.join("")).appendTo(l);this.listEl.attr("isInWin",false)}else{this.listEl=$(h.join("")).attr("isInWin",true);this.el.after(this.listEl)}}var e=this.listEl.children("div.hc_selectbox-tree-left").children("ul.ztree");this.treeEl=e;var c=false;if(this.params.url&&this.params.url!=""){c=true}var o={view:{nameIsHTML:true,showLine:false,showIcon:true,showTitle:true,selectedMulti:true,dblClickExpand:true,fontCss:this.getFontCss},data:{key:{name:"name",title:"name"},simpleData:{enable:true,idKey:"id",pIdKey:"pId"}},callback:{beforeClick:this.beforeClick,beforeCheck:this.params.beforeCheck?window[this.params.beforeCheck]:null,beforeAsync:this.params.beforeAsync?window[this.params.beforeAsync]:null,onAsyncSuccess:this.params.onAsyncSuccess?window[this.params.onAsyncSuccess]:null,onAsyncError:this.params.onAsyncError?window[this.params.onAsyncError]:null,beforeCollapse:this.params.beforeCollapse?window[this.params.beforeCollapse]:null,beforeDblClick:this.params.beforeDblClick?window[this.params.beforeDblClick]:null,beforeDrag:this.params.beforeDrag?window[this.params.beforeDrag]:null,beforeDragOpen:this.params.beforeDragOpen?window[this.params.beforeDragOpen]:null,beforeDrop:this.params.beforeDrop?window[this.params.beforeDrop]:null,beforeEditName:this.params.beforeEditName?window[this.params.beforeEditName]:null,beforeExpand:this.params.beforeExpand?window[this.params.beforeExpand]:null,beforeMouseDown:this.params.beforeMouseDown?window[this.params.beforeMouseDown]:null,beforeMouseUp:this.params.beforeMouseUp?window[this.params.beforeMouseUp]:null,beforeRemove:this.params.beforeRemove?window[this.params.beforeRemove]:null,beforeRename:this.params.beforeRename?window[this.params.beforeRename]:null,beforeRightClick:this.params.beforeRightClick?window[this.params.beforeRightClick]:null,onCheck:this.onCheck,onCollapse:this.params.onCollapse?window[this.params.onCollapse]:null,onDblClick:this.params.onDblClick?window[this.params.onDblClick]:null,onDrag:this.params.onDrag?window[this.params.onDrag]:null,onDragMove:this.params.onDragMove?window[this.params.onDragMove]:null,onExpand:this.params.onExpand?window[this.params.onExpand]:null,onMouseDown:this.params.onMouseDown?window[this.params.onMouseDown]:null,onMouseUp:this.params.onMouseUp?window[this.params.onMouseUp]:null,onNodeCreated:this.params.onNodeCreated?window[this.params.onNodeCreated]:null,onRemove:this.params.onRemove?window[this.params.onRemove]:null,onRename:this.params.onRename?window[this.params.onRename]:null,onRightClick:this.params.onRightClick?window[this.params.onRightClick]:null,onClick:this.onCheck},async:{enable:c,url:this.params.url?this.params.url:"",autoParam:this.params.otherParam?this.params.otherParam:[],otherParam:this.params.otherParam?this.params.otherParam:{},type:this.params.type?this.params.type:"post",dataFilter:this.params.dataFilter?window[this.params.dataFilter]:null}};var m=this.hidden.attr("checkMode");if(m&&m=="checkbox"){o.check={enable:true,chkStyle:m,chkboxType:{Y:"",N:""}}}var f=this.hidden.attr("data-data");if(f&&f!=""){f=$.parseJSON(f)}else{f=[]}this.treedata=f;if(c){this.zTreeObj=$.fn.zTree.init(e,o)}else{this.zTreeObj=$.fn.zTree.init(e,o,f)}var d=this.treeEl.attr("id");this.treeObj=$.fn.zTree.getZTreeObj(d);this.treeObj.expandAll(expandFirst);var k=this.hidden.attr("value");var g=this.treeObj.getNodesByParam("id",k,null);if(g&&g[0]!=null&&g[0]!={}){this.field.val(g[0].name);this.showLog(g,this.treeObj,true)}else{this.field.val("")}var b=this.treeObj;var j="name";if(this.hidden.attr("filterBy")){j=this.hidden.attr("filterBy")}this.field.bind("keyup",function(q){b.expandAll(true);var p=b.getNodesByParamFuzzy(j,this.value,null);if(this.value!=""){$.each(p,function(r,s){s.highlight=true;b.updateNode(s);b.expandNode(s.getParentNode(),true)})}else{$.each(p,function(r,s){s.highlight=false;b.updateNode(s)});b.expandAll(expandFirst)}this.focus()});this.field.bind({blur:function(){$(this).val($(this).attr("selectNodes"));var p=b.getNodesByParam("highlight",true,null);$.each(p,function(q,r){r.highlight=false;b.updateNode(r)})}})},onBeforeCheck:function(a,c){var b=$.fn.zTree.getZTreeObj(a);var d=b.thisScope;return(function(){var f=this.hidden.attr("isLevelSelect")=="true";var e=this.hidden.attr("checkMode")=="checkbox"||this.hidden.attr("checkbox")=="radio";if(e){if(f){if(this.hidden.data("level")!=undefined&&c.level!=this.hidden.data("level")){return false}this.hidden.data("level",c.level)}}}).apply(d,arguments)},onAsyncSuccess:function(b,e,d,f){var h=this;var a=$.fn.zTree.getZTreeObj(e);a.expandAll(expandFirst);var g=h.hidden.attr("value");var c=a.getNodesByParam("id",g,null);if(c&&c[0]!=null&&c[0]!={}){h.field.val(c[0].name);h.showLog(c,a,true)}else{h.field.val("")}},getFontCss:function(b,a){return(a.highlight)?{color:"rgb(255, 0, 0)","font-weight":"bold"}:{color:"#333","font-weight":"normal"}},onCheck:function(d,c,b){var a=$.fn.zTree.getZTreeObj(c);var f=a.thisScope;return(function(){var g=a.getCheckedNodes();var e=this.hidden.attr("checkMode");var g=new Array();if(e&&e=="checkbox"){g=a.getCheckedNodes()}else{g=a.getSelectedNodes()}this.showLog.call(this,g,a,e,true);if(this.params.onCheck){var h=window[this.params.onCheck];h()}}).apply(f,arguments);this.field.trigger("blur")},showLog:function(a,c,b,j){var i="dark";var d=[];var h=[];var l=[];var k=[];var g=[];var f=this.listEl.children("div.hc_selectbox-tree-left").children("ul.ztree");var e=f.parent().next("div.hc_selectbox-tree-right").children("ul.ztree");$.each(a,function(o,q){var p="ztree_node_"+q.tId;var r=q.name;var n=q.id;var m=q.pId;l.push(r);g.push(n);k.push(m);d.push(p);h.push(q.tId);e.children("li[zid='"+p+"']");if(e.children("li[zid='"+p+"']").length==0){e.append("<li class='"+i+"' zid='"+p+"'>"+r+"</li>")}});e.children("li").each(function(n,m){var o=$(m);if(jQuery.inArray(o.attr("zid"),d)==-1){o.remove()}});this.hidden.val(g.join(","));if(b){this.field.val(l.join(","));this.field.attr("selectNodes",l.join(","));this.field.attr("pIds",k.join(","));this.field.attr("title",l.join(","))}else{this.field.val(l.join(","));this.field.attr("pIds",k.join(","));this.field.attr("selectNodes",l.join(","))}this.hidden.attr("tids",h.join(","));var b=this.hidden.attr("checkMode");if(!b||b=="radio"){if(j!=undefined){if(j){this.hideTree(this.field,this.listEl)}else{this.showTree(this.field,this.listEl)}}}this.validate()},clearLog:function(){var a=this.listEl.children("div.hc_selectbox-tree-right").children("ul.ztree");a.children("li").remove()},onFocus:function(h){var j=Horn.getCurrent();this.listEl=j.find("div.hc_selectbox-tree-div[ref_target='"+this.ref+"']");this.listEl.find("div.hc_selectbox-tree-left").width(this.field.width()+30);if(this.listEl.attr("isInWin")=="true"){if(this.field.width()<390){this.listEl.find("div.hc_selectbox-tree-left").width(this.field.width()+30)}}var n=$(h.currentTarget);var g=n.attr("ref");var l=$("div.hc_selectbox-tree-div[ref_target='"+g+"']");if(l.length>0){this.showTree(n,l);var k=$.fn.zTree.getZTreeObj(g);k.thisScope=this;k.currentTarget=n;var c=this.hidden.attr("checkMode")=="checkbox"||this.hidden.attr("checkMode")=="radio";this.clearLog(k);k.checkAllNodes(false);k.selectNode(null,false);if(this.hidden.val()){tIdArrs=this.hidden.attr("tids")||"";tIdArrs=tIdArrs.split(",");var b=[];for(var f=0;f<tIdArrs.length;f++){if(tIdArrs[f]){var d=k.getNodeByTId(tIdArrs[f]);b.push(d);if(c){k.checkNode(d,true,true,false)}else{k.selectNode(d,false)}}}this.showLog(b,k,c,false)}}var a=n.prev();var o=a.attr("search");var m=a.attr("filterBy");if(o||m){n.val("");n.removeAttr("readonly")}},hideTree:function(c,b){if(!b.data("show_name")){return}b.hide();b.data("show_name",false);var d=c.attr("ref");var a=$.fn.zTree.getZTreeObj(d);a.thisScope=null;a.currentTarget=null},showTree:function(f,e){if(e.data("show_name")){return}this.hideAllList(e);var d={inputEl:f,listEl:e};var g=f.offset(),b=f.outerHeight();var a=f.position();var h=e.get(0).style;var c=e.find("li");if(e.attr("isInWin")=="true"){h.left=(a.left)+"px";h.top=(a.top+b)+"px";c.find("a").css({"min-width":"120px"});c.find("span").css({padding:"0px","text-align":"left"});c.find("span.button").css({width:"18px"});c.find("span.button.chk").css({width:"14px"})}else{h.left=(g.left)+"px";h.top=(g.top+b)+"px"}e.show();e.data("show_name",true);e.bind("click.ztree.list",d,function(i){Horn.Util.stopPropagation(i)});$(document).one("click.combo.body",d,Horn.Util.apply(this.bodyClick,this))},hideAllList:function(a){$("div.hc_selectbox-tree-div").each(function(b,c){if(a.get(0)!=c){$(c).hide();$(c).data("show_name","")}})},bodyClick:function(c){var b=c.data.inputEl;if(c.target==b.get(0)){$(document).one("click.combo.body",c.data,Horn.Util.apply(this.bodyClick,this))}else{var a=c.data.listEl;this.hideTree(b,a)}},setEnable:function(a){if(a){this.field.removeAttr("disabled");this.hidden.removeAttr("disabled")}else{this.field.attr("disabled","disabled");this.hidden.attr("disabled","disabled")}},setValue:function(b){var a=this.treeObj.getNodesByParam("id",b,null);if(a&&a[0]!=null&&a[0]!={}){this.field.val(a[0].name);this.showLog(a,this.treeObj,true)}else{this.field.val("");this.showLog({},this.treeObj,true)}this.validate()},getSelectedNodes:function(){var a=this.hidden.attr("checkMode");if(!a||a=="radio"){return this.treeObj.getSelectedNodes()}else{return this.treeObj.getCheckedNodes()}},getValue:function(){var a=this.get();var b=a.val();return b},getText:function(){var a=this.field;var b=a.attr("selectnodes");return b},getPid:function(){var a=this.field;var b=a.attr("pIds");return b}});Horn.Field.regFieldType("div.hc_select-tree",Horn.SelectTree);