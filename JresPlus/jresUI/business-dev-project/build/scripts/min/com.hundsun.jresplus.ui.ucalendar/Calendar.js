(function(a){a.fn.datetimepicker.dates["zh-CN"]={days:["星期日","星期一","星期二","星期三","星期四","星期五","星期六","星期日"],daysShort:["周日","周一","周二","周三","周四","周五","周六","周日"],daysMin:["日","一","二","三","四","五","六","日"],months:["1","2","3","4","5","6","7","8","9","10","11","12"],monthsShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],today:"今天",suffix:[],meridiem:["上午","下午"]}}(jQuery));Horn.Calendar=Horn.extend(Horn.Field,{COMPONENT_CLASS:"Calendar",init:function(dom){Horn.Calendar.superclass.init.apply(this,arguments);var input=this.el.children("input:text");var hidden=this.el.children("input:hidden");this.name=hidden.attr("name");this.alias=hidden.attr("alias");var config=this.params.config;var settings={};if(config&&typeof(config)=="string"){settings=eval("("+config+")")}else{if(typeof(config)=="object"){settings=config}else{settings={}}}this.format=settings.format;if(!settings.format){settings.format=Horn.Calendar.DEFAULT_FORMAT;hidden.attr("format","noConfig")}else{hidden.attr("format","yesConfig")}settings.btnBar=false;this.settings=settings;this.minDate=Horn.Util.Format.date(settings.minDate,"yyyy-MM-dd HH:mm");this.maxDate=Horn.Util.Format.date(settings.maxDate,"yyyy-MM-dd HH:mm");this.initDate=function(conf){var lformat=conf.format.toLowerCase();var viewNo=conf.format.indexOf("m")>-1?0:lformat.indexOf("h")>-1?1:lformat.indexOf("d")>-1?2:conf.format.indexOf("M")>-1?3:4;if(viewNo===3){conf.noToday=true}var that=this;this.calobj=input.datetimepicker({format:conf.format,startDate:that.minDate,endDate:that.maxDate,language:"zh-CN",autoclose:true,minView:viewNo,startView:viewNo===3?4:2,todayBtn:conf.noToday===true?false:true}).on("changeDate",function(e){var h=e.date.getHours()-8;e.date.setHours(h);var date=e.date.format(conf.format);this.value=date;that.hidden.val(date);if(that.params.focusShowCalendar==false||that.params.canEditable==false){that._inputValue=date}}).on("hide",function(){input.trigger("blur");if(that._inputValue!=null){var date;if(that._inputValue==""){date=""}else{date=Horn.Util.Format.date(that._inputValue,that.settings.format);if(that.params.focusShowCalendar==false||that.params.canEditable==false){date=that._inputValue}if(date.indexOf("1899")==0){date=that._inputValue}}that.hidden.val(date);this.value=date;that._inputValue=null}else{this.value=that.hidden.val()}}).datetimepicker("setStartDate",that.minDate).datetimepicker("setEndDate",that.maxDate)};var that=this;input.focus(function(){var _org=$(this).val();if(_org&&_org.indexOf("/")==-1&&_org.indexOf("-")==-1){var _ttt=Horn.Util.Format.date(_org,"yyyy-MM-dd");$(this).val(_ttt)}return true}).keyup(function(e){that._inputValue=$(this).val();that.hidden.val($(this).val())}).keypress(function(e){that._inputValue=$(this).val();that.hidden.val($(this).val())}).blur(function(e){that.formatValue();that.validate()});var disabled=this.field.attr("disabled");if(disabled&&disabled=="disabled"){return}var $a=input.next("i");var inputNotShow=input.attr("inputNotShow");$a.click(function(){var disabled=that.field.attr("disabled");if(disabled&&disabled=="disabled"){return}input.attr("focusShowCalendar","true");input.attr("canEditable","true");input.focus();input.focus();if(inputNotShow=="false"){input.attr("focusShowCalendar","false");input.attr("canEditable","false")}});this.initDate(settings);if(this.params.readonly){this.setReadonly(true)}if(this.params.disabled){this.setDisabled(true)}var val=hidden.val();if(val!=""){this.setValue(val)}},getEventTarget:function(){return this.el.children("input:text")},setValue:function(a){this.field.val(a);this.hidden.val(a);this.validate()},getValue:function(){var a=this.get().val();if(a!=null&&a!=""){a=a+"";a=a.replace(/(^\s*)|(\s*$)/g,"")}if(a!=""){a=Horn.Util.Format.date(a,this.settings.format)}else{a=""}return a},reset:function(a){this.field.val(a?"":this.defValue);this.hidden.val(a?"":this.defHiddenValue);this.validate()},validate:function(){this.removeError();this.err=false;var a=true;var h=this;h.formatValue();var b=h.hidden.attr("check");if(b&&b.length>0&&!this.params.config){if(h.calobj.val()!=""){var g=b.split(";");var c="";for(var d=0;d<g.length;d++){var j=g[d];var e=function(){};if(j!=""&&j!="Horn.Validate.validateFmt"&&j!=Horn.Validate.REQUIRED){if(window[j]){e=window[j];var f=e();if(f!=true){a=false;c=f;break}}else{if(window.ruleFunc){var f=j;if(f!=true){a=false;c=f;break}}}}}if(!a){h.showError(f);a=false;this.err=true;return}else{this.removeError();this.err=false}}}if(h.calobj.val()!=""){if(!Horn.Util.Format.validateFmt(h.calobj.val(),h.settings.format)){a=false;this.err=true;h.showError("日期格式不正确,格式为："+h.settings.format);return}}else{if(b&&b.indexOf(Horn.Validate.REQUIRED)>-1){a=false;this.err=true;h.showError("该输入不能为空！");return}}},formatValue:function(){var a=this;var b=a.hidden.val();if(b!=""){date=Horn.Util.Format.date(b,a.settings.format)}else{date=""}if(date.indexOf("1899")==0){date=a.hidden.val()}a.hidden.val(date);a.calobj.val(date);a.value=date},isValid:function(){if(this.calobj.val()==null||this.calobj.val()==""){var a=this.hidden.attr("check");if(a&&a.indexOf(Horn.Validate.REQUIRED)>-1){return false}else{return true}}else{return(Horn.Util.Format.validateFmt(this.calobj.val(),this.settings.format)&&!this.err)?true:false}},initEvents:function(){var a=this;a.checkRegx=[];var b=this.field.attr("checkstr");if(b){a.checkRegx=b.split(";")}this.field.blur(function(){var e="yyyy-MM-dd";if(a.settings){var d=a.settings.format;if(d){e=d}}var f=$(this).val();if(f!=""){var c=Horn.Util.Format.date(f,e);$(this).val(c)}setTimeout(function(){var h=a.hidden.attr("check");var m=true;if(h&&h.length>0&&!a.params.config){if(a.calobj.val()!=""){var j=h.split(";");var n="";for(var k=0;k<j.length;k++){var o=j[k];if(o!=""&&o!="Horn.Validate.validateFmt"&&o!=Horn.Validate.REQUIRED){var l=window[o];var g=l();if(g!=true){m=false;n=g;break}}}if(!m){a.showError(g);m=false;a.err=true;return}else{a.removeError();a.err=false}}}if(a.calobj.val()!=""){if(!Horn.Util.Format.validateFmt(a.calobj.val(),a.settings.format)){a.showError("日期格式不正确,格式为："+a.settings.format)}else{a.removeError();Horn.Validate.onValid({data:[Horn.Validate,a]})}}else{a.removeError();var h=a.hidden.attr("check");if(h&&h.indexOf(Horn.Validate.REQUIRED)>-1){a.showError("该输入不能为空！")}}},10)})},setEnable:function(a){if(a){this.field.removeAttr("disabled");this.hidden.removeAttr("disabled")}else{this.field.attr("disabled","disabled");this.hidden.attr("disabled","disabled")}},setReadonly:function(a){Horn.Calendar.superclass.setReadonly.apply(this,arguments);if(this.readonly){this.calobj.datetimepicker("remove")}else{this.initDate(this.settings)}}});Horn.apply(Horn.Calendar,{DEFAULT_FORMAT:"yyyy-MM-dd"});Horn.Field.regFieldType("div.hc_calendar",Horn.Calendar);